{% extends "base.html" %}

{% block title %}NSN Integration Test{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="header">
        <h1 class="title">NSN Integration Test</h1>
        <p class="subtitle">Test B-Client communication with NSN server</p>
    </div>

    <div class="test-section">
        <h2>NSN Server Status</h2>
        <div id="nsn-status" class="status-card">
            <div class="status-indicator" id="status-indicator">⏳</div>
            <div class="status-text" id="status-text">Checking NSN server...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>User Information Query</h2>
        <div class="test-form">
            <input type="text" id="username-input" placeholder="Enter username" class="form-input">
            <button id="query-user-btn" class="test-button">Query User Info</button>
        </div>
        <div id="user-info-result" class="result-box"></div>
    </div>

    <div class="test-section">
        <h2>NSN Login Test</h2>
        <div class="test-form">
            <input type="text" id="login-username" placeholder="Username" class="form-input">
            <input type="password" id="login-password" placeholder="Password" class="form-input">
            <button id="login-test-btn" class="test-button">Test Login</button>
        </div>
        <div id="login-result" class="result-box"></div>
    </div>

    <div class="test-section">
        <h2>Session Cookie Test</h2>
        <div class="test-form">
            <input type="text" id="session-cookie" placeholder="Session cookie" class="form-input">
            <button id="session-test-btn" class="test-button">Test Session</button>
        </div>
        <div id="session-result" class="result-box"></div>
    </div>

    <div class="test-section">
        <h2>NSN Environment Variables</h2>
        <div class="test-form">
            <button id="env-check-btn" class="test-button">Check NSN Environment</button>
        </div>
        <div id="env-result" class="result-box"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    class NSNTester {
        constructor() {
            this.apiBase = window.location.origin;
            this.init();
        }

        async init() {
            await this.checkNSNStatus();
            this.setupEventListeners();
        }

        async checkNSNStatus() {
            try {
                const response = await fetch(`${this.apiBase}/api/nsn/status`);
                const data = await response.json();

                const indicator = document.getElementById('status-indicator');
                const text = document.getElementById('status-text');

                if (data.success) {
                    indicator.textContent = '✅';
                    text.textContent = `NSN Server Online (${data.nsn_url}) - Response time: ${data.response_time.toFixed(2)}s`;
                } else {
                    indicator.textContent = '❌';
                    text.textContent = `NSN Server Offline (${data.nsn_url}) - Error: ${data.error}`;
                }
            } catch (error) {
                const indicator = document.getElementById('status-indicator');
                const text = document.getElementById('status-text');
                indicator.textContent = '❌';
                text.textContent = `Failed to check NSN status: ${error.message}`;
            }
        }

        setupEventListeners() {
            document.getElementById('query-user-btn').addEventListener('click', () => {
                this.queryUserInfo();
            });

            document.getElementById('login-test-btn').addEventListener('click', () => {
                this.testLogin();
            });

            document.getElementById('session-test-btn').addEventListener('click', () => {
                this.testSession();
            });

            document.getElementById('env-check-btn').addEventListener('click', () => {
                this.checkNSNEnvironment();
            });
        }

        async queryUserInfo() {
            const username = document.getElementById('username-input').value;
            if (!username) {
                this.showResult('user-info-result', 'Please enter a username', 'error');
                return;
            }

            try {
                const response = await fetch(`${this.apiBase}/api/nsn/user-info`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await response.json();
                this.showResult('user-info-result', JSON.stringify(data, null, 2), data.success ? 'success' : 'error');
            } catch (error) {
                this.showResult('user-info-result', `Error: ${error.message}`, 'error');
            }
        }

        async testLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            if (!username || !password) {
                this.showResult('login-result', 'Please enter username and password', 'error');
                return;
            }

            try {
                const nmpParams = {
                    nmp_user_id: 'test_user_123',
                    nmp_username: username,
                    nmp_client_type: 'b-client',
                    nmp_timestamp: new Date().toISOString(),
                    nmp_ip_address: '127.0.0.1',
                    nmp_port: '3000'
                };

                const response = await fetch(`${this.apiBase}/api/nsn/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        password,
                        nmp_params: nmpParams
                    })
                });

                const data = await response.json();
                this.showResult('login-result', JSON.stringify(data, null, 2), data.success ? 'success' : 'error');
            } catch (error) {
                this.showResult('login-result', `Error: ${error.message}`, 'error');
            }
        }

        async testSession() {
            const sessionCookie = document.getElementById('session-cookie').value;
            if (!sessionCookie) {
                this.showResult('session-result', 'Please enter a session cookie', 'error');
                return;
            }

            try {
                const response = await fetch(`${this.apiBase}/api/nsn/current-user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_cookie: sessionCookie })
                });

                const data = await response.json();
                this.showResult('session-result', JSON.stringify(data, null, 2), data.success ? 'success' : 'error');
            } catch (error) {
                this.showResult('session-result', `Error: ${error.message}`, 'error');
            }
        }

        async checkNSNEnvironment() {
            try {
                // Get NSN URL from B-Client configuration
                const configResponse = await fetch(`${this.apiBase}/api/config`);
                const config = await configResponse.json();
                const nsnUrl = config.api?.nsn_url || 'http://localhost:5000';

                // Call NSN environment API
                const response = await fetch(`${nsnUrl}/api/nsn_websocket_env`);
                const data = await response.json();

                const formattedResult = {
                    'NSN Server': nsnUrl,
                    'Environment': data.environment,
                    'B_CLIENT_API_URL': data.B_CLIENT_API_URL,
                    'B_CLIENT_WEBSOCKET_URL': data.B_CLIENT_WEBSOCKET_URL,
                    'NSN_URL': data.NSN_URL
                };

                this.showResult('env-result', JSON.stringify(formattedResult, null, 2), 'success');
            } catch (error) {
                this.showResult('env-result', `Error: ${error.message}`, 'error');
            }
        }

        showResult(elementId, content, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre class="result-${type}">${content}</pre>`;
        }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        new NSNTester();
    });
</script>

<style>
    .test-section {
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .test-section h2 {
        margin-bottom: 15px;
        color: #2d3748;
    }

    .status-card {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: #f7fafc;
        border-radius: 8px;
        border-left: 4px solid #4299e1;
    }

    .status-indicator {
        font-size: 20px;
    }

    .status-text {
        font-weight: 500;
        color: #2d3748;
    }

    .test-form {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .form-input {
        flex: 1;
        min-width: 200px;
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
    }

    .test-button {
        padding: 10px 20px;
        background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .test-button:hover {
        background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
        transform: translateY(-1px);
    }

    .result-box {
        margin-top: 10px;
    }

    .result-box pre {
        padding: 15px;
        border-radius: 6px;
        font-size: 12px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-word;
    }

    .result-success {
        background: #f0fff4;
        border: 1px solid #9ae6b4;
        color: #22543d;
    }

    .result-error {
        background: #fed7d7;
        border: 1px solid #feb2b2;
        color: #742a2a;
    }
</style>
{% endblock %}