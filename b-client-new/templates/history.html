{% extends "base.html" %}

{% block title %}Browse History{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>
            <span>üìä</span>
            Browse History
        </h1>
        <p>Your browsing statistics and recent activity</p>
    </div>

    <div class="content">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading your browsing history...</p>
        </div>

        <div id="stats-container" style="display: none;">
            <div class="stats-grid" id="stats"></div>

            <div class="history-section">
                <h2>
                    <span>üìñ</span>
                    Recent History
                    <span id="history-count" style="font-size: 0.8em; color: #666; font-weight: normal;"></span>
                </h2>
                <div class="history-list" id="history-list"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Utility functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatTime(seconds) {
        if (seconds < 60) {
            return `${seconds.toFixed(1)}s`;
        } else if (seconds < 3600) {
            return `${(seconds / 60).toFixed(1)}min`;
        } else {
            return `${(seconds / 3600).toFixed(1)}h`;
        }
    }

    // Format date for display
    function formatDate(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
            return 'Today';
        } else if (diffDays === 2) {
            return 'Yesterday';
        } else if (diffDays <= 7) {
            return date.toLocaleDateString('en-US', { weekday: 'long' });
        } else {
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
    }

    // Get date class for styling
    function getDateClass(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays === 1) return 'today';
        if (diffDays === 2) return 'yesterday';
        return '';
    }

    // Generate stats cards
    function generateStats(stats) {
        return `
            <div class="stat-card visits">
                <div class="icon">üåê</div>
                <h3>Total Visits</h3>
                <div class="value">${stats.totalVisits || 0}</div>
                <div class="unit">pages</div>
            </div>
            <div class="stat-card time">
                <div class="icon">‚è±</div>
                <h3>Total Time</h3>
                <div class="value">${formatTime(stats.totalTime || 0)}</div>
                <div class="unit">browsing</div>
            </div>
            <div class="stat-card avg">
                <div class="icon">üìà</div>
                <h3>Average Stay</h3>
                <div class="value">${formatTime(stats.averageStayTime || 0)}</div>
                <div class="unit">per page</div>
            </div>
        `;
    }

    // Generate history list with date grouping
    function generateHistory(history) {
        if (!history || history.length === 0) {
            return `
                <div class="no-history">
                    <div class="icon">üì≠</div>
                    <h3>No browsing history yet</h3>
                    <p>Start browsing to see your history here.</p>
                </div>
            `;
        }

        // Sort history by timestamp (newest first)
        const sortedHistory = history.sort((a, b) => b.timestamp - a.timestamp);

        // Group by date
        const groupedHistory = {};
        sortedHistory.forEach(record => {
            const dateKey = new Date(record.timestamp).toDateString();
            if (!groupedHistory[dateKey]) {
                groupedHistory[dateKey] = [];
            }
            groupedHistory[dateKey].push(record);
        });

        // Generate HTML for each date group
        let historyHTML = '';
        Object.entries(groupedHistory).forEach(([dateKey, records]) => {
            const firstRecord = records[0];
            const dateClass = getDateClass(firstRecord.timestamp);

            // Add date separator
            historyHTML += `
                <div class="date-separator ${dateClass}">
                    üìÖ ${formatDate(firstRecord.timestamp)}
                </div>
            `;

            // Add records for this date
            records.forEach((record, index) => {
                const stayTime = record.stayDuration ? formatTime(record.stayDuration) : 'Active';
                const time = new Date(record.timestamp).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                let domain = 'Unknown';

                try {
                    domain = new URL(record.url).hostname;
                } catch (e) {
                    domain = record.url ? record.url.substring(0, 50) + '...' : 'Unknown';
                }

                const stayColor = record.stayDuration ?
                    (record.stayDuration > 60 ? '#4CAF50' : record.stayDuration > 10 ? '#FF9800' : '#757575') :
                    '#2196F3';

                historyHTML += `
                    <div class="history-item" style="border-left-color: ${stayColor};" data-index="${index}">
                        <div class="history-item-content">
                            <div class="history-item-info">
                                <div class="history-item-title">
                                    ${escapeHtml(record.title || 'Untitled Page')}
                                </div>
                                <div class="history-item-domain">
                                    <span>üåê</span>
                                    <span>${escapeHtml(domain)}</span>
                                </div>
                                <div class="history-item-time">
                                    <span>üïí</span>
                                    <span>${time}</span>
                                </div>
                            </div>
                            <div class="history-item-duration" style="background: ${stayColor};">
                                <span>‚è±</span>
                                <span>${stayTime}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
        });

        return historyHTML;
    }

    // Update page content
    function updateContent(historyData, statsData) {
        try {
            const loadingEl = document.getElementById('loading');
            const statsContainer = document.getElementById('stats-container');
            const statsEl = document.getElementById('stats');
            const historyListEl = document.getElementById('history-list');
            const historyCountEl = document.getElementById('history-count');

            if (!loadingEl || !statsContainer || !statsEl || !historyListEl || !historyCountEl) {
                return false;
            }

            loadingEl.style.display = 'none';
            statsContainer.style.display = 'block';

            const statsHTML = generateStats(statsData || {});
            statsEl.innerHTML = statsHTML;

            const historyHTML = generateHistory(historyData || []);
            historyListEl.innerHTML = historyHTML;

            const count = historyData ? historyData.length : 0;
            historyCountEl.textContent = `(Total ${count} visits)`;

            return true;
        } catch (error) {
            console.error('Error updating content:', error);
            return false;
        }
    }

    // Page initialization
    async function initializePage() {
        try {
            // For demo purposes, show empty history
            const historyData = [];
            const statsData = {
                totalVisits: 0,
                totalTime: 0,
                averageStayTime: 0
            };

            updateContent(historyData, statsData);
        } catch (error) {
            console.error('Error fetching history data:', error);
        }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializePage);
    } else {
        initializePage();
    }
</script>
{% endblock %}